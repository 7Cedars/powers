# Migration Guide: Old → New Organization System

This guide helps you migrate from the old organization deployment system to the new modular system.

## Overview of Changes

### Old System (3 files)
```
frontend/
├── app/SectionDeployCarousel.tsx        # UI + logic
├── public/deploymentForms.ts            # Form metadata
└── public/createLawInitData.ts          # Law generation
```

### New System (1 file per org)
```
frontend/
├── organisations/
│   ├── types.ts                         # Type definitions
│   ├── index.ts                         # Organization registry
│   ├── helpers.ts                       # Shared utilities
│   ├── PowerBase.ts                     # Power Base org
│   ├── Powers101.ts                     # Powers 101 org
│   └── [YourOrg].ts                     # Your new orgs
└── app/SectionDeployCarouselV2.tsx      # New UI component
```

## Migration Steps

### Step 1: Understanding the New Structure

Each organization is now a self-contained module with:

```typescript
export const MyOrganization: Organization = {
  metadata: {
    // What was in deploymentForms.ts
    id: "unique-id",
    title: "Display Name",
    uri: "ipfs://...",
    banner: "ipfs://...",
    description: "...",
    disabled: false,
    onlyLocalhost: false
  },
  
  fields: [
    // What was in deploymentForms.ts
    { name: "field1", placeholder: "...", type: "text", required: true }
  ],
  
  createLawInitData: (powersAddress, formData, chainId) => {
    // What was in createLawInitData.ts
    return lawInitData;
  }
};
```

### Step 2: Migrating an Existing Organization

Let's migrate "Powers 101" as an example.

**Old System - deploymentForms.ts:**
```typescript
{
  id: 1,
  title: "Powers 101",
  uri: "https://aqua-famous-sailfish-288.mypinata.cloud/ipfs/...",
  banner: "https://aqua-famous-sailfish-288.mypinata.cloud/ipfs/...",
  description: "A simple DAO...",
  disabled: false,
  onlyLocalhost: false,
  fields: []
}
```

**Old System - createLawInitData.ts:**
```typescript
export function createPowers101LawInitData(
  powersAddress: `0x${string}`, 
  formData: Powers101FormData, 
  chainId: number
): LawInitData[] {
  // Law generation logic...
}
```

**New System - organisations/Powers101.ts:**
```typescript
import { Organization } from "./types";
import { LawInitData, createConditions } from "@/public/createLawInitData";

export const Powers101: Organization = {
  metadata: {
    id: "powers-101",
    title: "Powers 101",
    uri: "https://aqua-famous-sailfish-288.mypinata.cloud/ipfs/...",
    banner: "https://aqua-famous-sailfish-288.mypinata.cloud/ipfs/...",
    description: "A simple DAO...",
    disabled: false,
    onlyLocalhost: false
  },

  fields: [],

  createLawInitData: (powersAddress, formData, chainId) => {
    // Paste law generation logic here
    const lawInitData: LawInitData[] = [];
    // ... rest of the logic
    return lawInitData;
  }
};
```

**Register in index.ts:**
```typescript
import { Powers101 } from "./Powers101";

export const organizations: Organization[] = [
  Powers101,
  // ... more orgs
];
```

### Step 3: Converting Function Patterns

**Pattern 1: Simple Organizations**

Old:
```typescript
// deploymentForms.ts
{ id: 1, title: "Simple DAO", fields: [] }

// createLawInitData.ts
export function createSimpleDaoLawInitData(...) {
  return [...];
}
```

New:
```typescript
// organisations/SimpleDAO.ts
export const SimpleDAO: Organization = {
  metadata: { id: "simple-dao", title: "Simple DAO", ... },
  fields: [],
  createLawInitData: (powersAddress, formData, chainId) => {
    return [...];
  }
};
```

**Pattern 2: Organizations with Form Fields**

Old:
```typescript
// deploymentForms.ts
{
  id: 4,
  title: "Bridging Off-Chain Governance",
  fields: [
    { name: "snapshotSpace", placeholder: "...", type: "text", required: false },
    { name: "chainlinkSubscriptionId", placeholder: "...", type: "number", required: true }
  ]
}

// createLawInitData.ts
export function createCrossChainGovernanceLawInitData(
  powersAddress: `0x${string}`,
  formData: CrossChainGovernanceFormData,
  chainId: number
): LawInitData[] {
  const subscriptionId = formData.chainlinkSubscriptionId ?? 0;
  // Use formData...
}
```

New:
```typescript
// organisations/BridgingGovernance.ts
export const BridgingGovernance: Organization = {
  metadata: {
    id: "bridging-governance",
    title: "Bridging Off-Chain Governance",
    ...
  },
  
  fields: [
    { name: "snapshotSpace", placeholder: "...", type: "text", required: false },
    { name: "chainlinkSubscriptionId", placeholder: "...", type: "number", required: true }
  ],
  
  createLawInitData: (powersAddress, formData, chainId) => {
    const subscriptionId = formData.chainlinkSubscriptionId ?? 0;
    // Rest of logic...
    return lawInitData;
  }
};
```

**Pattern 3: Organizations with Validation**

New system adds validation capability:

```typescript
export const ValidatedOrg: Organization = {
  metadata: { ... },
  fields: [ ... ],
  
  createLawInitData: (...) => { ... },
  
  // NEW: Add validation
  validateFormData: (formData) => {
    const errors: string[] = [];
    
    if (!formData.requiredField) {
      errors.push("Required field is missing");
    }
    
    if (formData.percentage && (formData.percentage < 0 || formData.percentage > 100)) {
      errors.push("Percentage must be between 0 and 100");
    }
    
    return {
      valid: errors.length === 0,
      errors: errors.length > 0 ? errors : undefined
    };
  }
};
```

### Step 4: Using Helper Functions

The new system provides reusable helpers:

**Old approach:**
```typescript
// Repeated in every function
const getLawAddress = (lawName: string, chainId: number): `0x${string}` => {
  const constants = getConstants(chainId);
  return constants.LAW_ADDRESSES[constants.LAW_NAMES.indexOf(lawName)];
};

const daysToBlocks = (days: number, chainId: number): bigint => {
  const constants = getConstants(chainId);
  return BigInt(Math.floor(days * constants.BLOCKS_PER_HOUR * 24));
};
```

**New approach:**
```typescript
// organisations/MyOrg.ts
import { getLawAddress, daysToBlocks, ADMIN_ROLE } from "./helpers";

export const MyOrg: Organization = {
  // ...
  createLawInitData: (powersAddress, formData, chainId) => {
    const lawAddress = getLawAddress("OpenAction", chainId);
    const period = daysToBlocks(7, chainId);
    // ...
  }
};
```

### Step 5: Updating the UI Component

**Old component:**
```typescript
// app/page.tsx
import { SectionDeployCarousel } from "./SectionDeployCarousel";

export default function Home() {
  return <SectionDeployCarousel />;
}
```

**New component:**
```typescript
// app/page.tsx
import { SectionDeployCarouselV2 } from "./SectionDeployCarouselV2";

export default function Home() {
  return <SectionDeployCarouselV2 />;
}
```

## Complete Migration Example

Let's migrate "Grants Manager" completely:

### 1. Create Organization File

```typescript
// organisations/GrantsManager.ts
import { Organization } from "./types";
import { LawInitData, createConditions } from "@/public/createLawInitData";
import { getLawAddress, getMockAddress, daysToBlocks, ADMIN_ROLE, PUBLIC_ROLE } from "./helpers";
import { encodeAbiParameters, encodeFunctionData } from "viem";
import { powersAbi } from "@/context/abi";

export const GrantsManager: Organization = {
  metadata: {
    id: "grants-manager",
    title: "Grants Manager",
    uri: "https://aqua-famous-sailfish-288.mypinata.cloud/ipfs/bafkreiawj6j4fkudjj6kr54ygn3j55cw3cvapuwqiib3uwfonoyyrr2q7i",
    banner: "https://aqua-famous-sailfish-288.mypinata.cloud/ipfs/bafybeibglg2jk56676ugqtarjzseiq6mpptuapal6xlkt5avm3gtxcwgcy",
    description: "Deploy a grant program using Powers...",
    disabled: false,
    onlyLocalhost: false
  },

  fields: [
    { 
      name: "parentDaoAddress", 
      placeholder: "Parent DAO or your own address (0x...)", 
      type: "text", 
      required: true 
    }
  ],

  createLawInitData: (powersAddress, formData, chainId) => {
    // Copy logic from createGrantsManagerLawInitData
    const lawInitData: LawInitData[] = [];
    
    // Law 1: Initial setup
    lawInitData.push({
      nameDescription: "RUN THIS LAW FIRST...",
      targetLaw: getLawAddress("PresetAction", chainId),
      config: encodeAbiParameters(/* ... */),
      conditions: createConditions({ allowedRole: PUBLIC_ROLE })
    });
    
    // ... rest of laws
    
    return lawInitData;
  },

  validateFormData: (formData) => {
    const errors: string[] = [];
    
    if (!formData.parentDaoAddress) {
      errors.push("Parent DAO address is required");
    } else if (!formData.parentDaoAddress.match(/^0x[a-fA-F0-9]{40}$/)) {
      errors.push("Invalid parent DAO address format");
    }
    
    return {
      valid: errors.length === 0,
      errors: errors.length > 0 ? errors : undefined
    };
  }
};
```

### 2. Register Organization

```typescript
// organisations/index.ts
import { GrantsManager } from "./GrantsManager";

export const organizations: Organization[] = [
  Powers101,
  PowerBase,
  GrantsManager, // Add here
];
```

### 3. Done!

The organization is now available in the deployment carousel.

## Benefits of Migration

### Before (Old System)
- ❌ Data scattered across 3 files
- ❌ Hard to find where to add new organizations
- ❌ No validation support
- ❌ Helper functions duplicated
- ❌ Unclear dependencies between files

### After (New System)
- ✅ All data in one file per organization
- ✅ Clear where to add new organizations
- ✅ Built-in validation support
- ✅ Shared helper functions
- ✅ Type-safe and modular
- ✅ Easy to test independently
- ✅ Self-documenting

## Checklist for Migrating Each Organization

- [ ] Create new file in `organisations/[OrgName].ts`
- [ ] Copy metadata from `deploymentForms.ts` to `metadata` section
- [ ] Copy fields from `deploymentForms.ts` to `fields` section
- [ ] Copy law generation logic from `createLawInitData.ts` to `createLawInitData` function
- [ ] Replace duplicated helpers with imports from `./helpers`
- [ ] Add validation logic to `validateFormData` (optional)
- [ ] Add mock contract requirements to `getMockContracts` (optional)
- [ ] Register organization in `organisations/index.ts`
- [ ] Test the organization in the UI
- [ ] Update any documentation

## Common Issues and Solutions

### Issue: Function selector not found
```typescript
// Problem: Hard-coded selector might be wrong
config: "0x12345678" as `0x${string}`

// Solution: Use helper constants
import { GrantFunctionSelectors } from "./helpers";
config: GrantFunctionSelectors.submitProposal
```

### Issue: Form data types
```typescript
// Problem: Accessing form data without type checking
const value = formData.someField;

// Solution: Check and parse appropriately
const value = formData.someField as string;
const numValue = formData.numField ? parseInt(formData.numField) : 0;
```

### Issue: Chain-specific addresses
```typescript
// Problem: Hard-coded addresses
const grantAddress = "0x1234...";

// Solution: Use mock address helper
const grantAddress = getMockAddress("GrantMock", chainId);
```

## Next Steps

1. Review the example organizations: `Powers101.ts` and `PowerBase.ts`
2. Read the readme for detailed documentation
3. Check USAGE EXAMPLE for patterns and examples
4. Start migrating your organizations one by one
5. Test each organization after migration
6. Once all are migrated, you can switch to `SectionDeployCarouselV2`

## Questions?

- **Where do I put organization-specific helpers?** In the organization file itself, or extract to `helpers.ts` if reusable
- **How do I test?** Create test files in `organisations/__tests__/[OrgName].test.ts`
- **Can I keep the old system?** Yes! The new system doesn't replace the old one, they can coexist
- **What about existing deployments?** They're unaffected - this only changes how new deployments are configured

Good luck with your migration! 🚀

